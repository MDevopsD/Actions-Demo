name: Detect and Release on Recent Changes

on:
  schedule:
    - cron: '0 2 * * *'  # Every day at 2 AM UTC
  workflow_dispatch:     # Allow manual triggering

jobs:
  check-for-changes:
    runs-on: ubuntu-latest

    outputs:
      changed: ${{ steps.check_changes.outputs.changed }}

    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Important to access full commit history

      - name: Check for file changes in the last 24 hours
        id: check_changes
        run: |
          set -e

          echo "🔍 Checking for commits in the last 24 hours..."

          # Debug: print commit history
          echo "🔧 Commit history in the last 24h:"
          git log --since="24 hours ago" --oneline || echo "No commits"

          # Get latest commit hash in last 24 hours
          RECENT_COMMIT=$(git log --since="24 hours ago" --pretty=format:"%H" -n 1)

          if [ -z "$RECENT_COMMIT" ]; then
            echo "ℹ️ No recent commits in last 24 hours."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "🕓 Last commit: $RECENT_COMMIT"

          # Detect changes in files since that commit
          CHANGES=$(git diff --name-only "$RECENT_COMMIT"..HEAD)

          if [ -n "$CHANGES" ]; then
            echo "✅ Changes detected:"
            echo "$CHANGES"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "ℹ️ Commit found but no file changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
  test-and-release:
    needs: check-for-changes
    if: needs.check-for-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Do your release
        run: echo "🚀 Releasing code..."

  no-changes:
    needs: check-for-changes
    if: needs.check-for-changes.outputs.changed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No changes detected
        run: echo "ℹ️ No changes in last 24 hours. Skipping release."
